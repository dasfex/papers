# Geospatial indexing

Огромное количество продуктов, которые мы делаем своими руками, так или иначе работает с геоинформацией. Где находится ближайшее кафе? Или точка выдачи заказа? А ближайший водитель такси? Когда речь идёт о хранении информации об объектах на карте и их поиске, мы приходим к geospatial indexing. Такую задачу ещё иногда называют proximity search (буквально поиск ближайшего). 

Посмотрим с вами на общепринятые подходы к решению подобной задачи и попытаемся разобраться, что и где можно заиспользовать из коробки. 

Давайте начнём с уточнения задачи. Пусть наш пользователь хочет найти все бизнесы рамках некоторого радиуса от его местоположения.

> Когда я говорю бизнес, понимаю любое место, где оказывают услуги: магазин, кафе, банк, нотариус, что угодно другое.

![Ищем что-то в Минске](https://github.com/user-attachments/assets/36bca7f2-1e38-4fca-9e04-62acf6d22eaa)

Самым простым подходом будет сделать такой запрос:
```sql
SELECT business_id, latitude, longitude
FROM business
WHERE (latitude BETWENN {:my_lat} - radius AND {:my_lat} + radius)
  AND (longitude BETWENN {:my_long} - radius AND {:my_long} + radius)
```

Так мы найдём все нужные бизнесы в пределах bounding box нашего круга. Проблема в том, что такой запрос неэффективен. Нам придётся просканировать всю таблицу в БД и проверить каждый отдельный бизнес на условие. Если ваша табличка содержит десятки-сотни миллионов записей, будет неприятно. 

Можно попробовать улучшить ситуацию и сделать индексы на latitude и longitude колонки. Это сделает чуть лучше, но не прям. 

<img width="822" alt="Ситуация при индексах на широту и долготу" src="https://github.com/user-attachments/assets/d8ea4bee-5b9b-4e63-b114-5d1ec2c4e5fb">

Даже если у вас есть индексы, при запросе мы обойдём все бизнесы в мире (!!!) с подходящей долготой и аналогично с широтой. После чего придётся пересекать пулы значений. На масштабах планеты это может быть долго. 


![Основные подходы к решению нашей задачи](https://github.com/user-attachments/assets/4cd4117f-53ec-4937-ba64-1d83c331dfb1)

